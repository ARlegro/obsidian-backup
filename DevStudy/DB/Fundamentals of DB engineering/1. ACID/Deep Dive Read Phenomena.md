[[2. Isolation of ACID]] << ì—¬ê¸°ì„œ ì–¸ê¸‰ í–ˆì—ˆìŒ 



## 1.  Phantom Reads
>[!tip] í•œ íŠ¸ëœì­ì…˜ ë‚´ ê°™ì€ í€„ë¦¬ ë‘ ë²ˆ ì‹¤í–‰í–ˆì„ ë•Œ, ì²« ë²ˆì§¸ ì¿¼ë¦¬ì—ì„œëŠ” ì—†ë˜ **'new row'ê°€ ë‘ ë²ˆì§¸ ì¿¼ë¦¬ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ”** í˜„ìƒ 
>- ë³´í†µ ë™ì‹œì„±ì´ ìˆê³ , íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì´ ì¶©ë¶„íˆ ë†’ì§€ ì•Šìœ¼ë©´ ë°œìƒí•œë‹¤.


ë§ì€ ì‚¬ëŒë“¤ì´ ê°„ê³¼í•˜ëŠ” ê°œë…ì´ë‹¤. ì˜ëª» ì‚¬ìš©í•˜ë©´ ì—„ì²­ í° ë¬¸ì œë¥¼ ì¼ìœ¼í‚¨ë‹¤.

### ë¬¸ì œê°€ ë˜ëŠ” ì˜ˆì‹œ 

```SQL
-- T1 BEGIN 
BEGIN TRANSACTION 

-- T2 BEGIN 
BEGIN TRANSACTION 

--T1 SELECT 
SELECT * FROM sales;
 id | price |    date    
----+-------+------------
  1 |    10 | 2024-01-07
  2 |    13 | 2024-03-07
(2 rows)

T2 ë°ì´í„° ì‚½ì… 
INSERT INTO salses (id, price, date) 
VALUES (3, 15, 'feb-7-2024');

-- T1 SELECT 
SELECT * FROM SALES
SELECT * FROM sales;
 id | price |    date    
----+-------+------------
  1 |    10 | 2024-01-07
  2 |    13 | 2024-03-07
  3 |    15 | 2024-02-07
(3 rows)
ğŸ’¢í•œ íŠ¸ëœì­ì…˜ì—ì„œ ê°™ì€ ì½ê¸°ì˜ ê²°ê³¼ê°€ ë‹¤ë¦„ 
```

### í•´ê²° in Postgres
postgresëŠ” Phantom Readë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë°©ë²•ì„ ì œê³µí•œë‹¤.

>[!tip] PostgresSQLì€ Repeatble Read ê²©ë¦¬ ìˆ˜ì¤€ì„ì—ë„ Phantom Readë¥¼ ë°©ì§€í•œë‹¤.
>- **ë°˜ë©´**, MySQL(ì˜ˆì „), Oracle, SQL Serverê°™ì€ ë‹¤ë¥¸ DBì—ì„œëŠ” 
>	1. **Serializable** ê²©ë¦¬ ìˆ˜ì¤€ì„ ì‚¬ìš©í•´ì•¼ Phantom Readë¥¼ ì œê±°í•  ìˆ˜ ìˆë‹¤.
>	2. ë˜ëŠ”, **ë¹„ê´€ì  ë½**ì„ ì‚¬ìš©í•´ì„œ íŒ¬í…€ ë¦¬ë“œ ë°©ì§€ 
>	   
>- ìµœê·¼ MYSQLì€ MVCC NEXT-KEY LOCKì¨ì„œ Phantom Readë°©ì§€ê°€ëŠ¥í•˜ë‹¤ë„¤ 

#### MVCC for protecting Phantom Read 
Postgresê°€ ë‚®ì€ ê²©ë¦¬ ìˆ˜ì¤€ì—ë„ Phantom Readë¥¼ ë°©ì§€í•  ìˆ˜ ìˆëŠ” ì´ìœ ëŠ” '**MVCC**'êµ¬í˜„ ë•ë¶„ì´ë‹¤.
- PostgresëŠ” MVCC(Multi-Version Concurrency Control) ë²„ì „ê´€ë¦¬ ë°©ì‹ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•œë‹¤. 
- **íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë  ë•Œ íŠ¹ì • ì‹œì ì˜ ë°ì´í„° ìŠ¤ëƒ…ìƒ·ì„ ìƒì„±**í•˜ë©°, ì´ ìŠ¤ëƒ…ìƒ·ì€ íŠ¸ëœì­ì…˜ ìˆ˜ëª… ë™ì•ˆ ìœ ì§€ë©ë‹ˆë‹¤.  â­â­
- ì´ ìŠ¤ëƒ…ìƒ·ì€ ê¸°ì¡´ í–‰ì˜ ë³€ê²½ë¿ë§Œ ì•„ë‹ˆë¼ **ìƒˆë¡œìš´ í–‰ì˜ ì‚½ì…ê¹Œì§€ë„ í•´ë‹¹ íŠ¸ëœì­ì…˜ì—ê²ŒëŠ” ë³´ì´ì§€ ì•Šë„ë¡ ì²˜ë¦¬**

ì¶”ê°€ë¡œ, ì´ëŸ¬í•œ ë°©ë²•ì€ ë²”ìœ„ ì ê¸ˆì´ í•„ìš”ê°€ ì—†ëŠ” ê²ƒ 

**MVCC ì¥ì ** âœ…
- **ë†’ì€ ë™ì‹œì„±** 
- **ë°ë“œë½ ê°ì†Œ** : MYSQLê³¼ ë‹¬ë¦¬ Gap/Next-Key Lockì„ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ëŒ€ëŸ‰ UPDATE í™˜ê²½ì—ì„œë„ ê²½í•©ì´ ìƒëŒ€ì ìœ¼ë¡œ ì ìŒ 


#### ë‹¤ë¥¸ DBì™€ ë‹¤ë¥¸ ì „ëµ 

- **PosgresSQL** : ë³€ê²½ í›„ ì¶©ëŒ ë‚˜ë©´ ë¡¤ë°± 
	- ë™ì‹œì„±ì´ ë§¤ìš° ë›°ì–´ë‚¨

- **MySQL** : ì ê¸ˆì„ ë¨¼ì € ê±¸ì–´ ë³€ê²½ ìì²´ë¥¼ ì°¨ë‹¨ 
	- ìµœì‹  MySQLì€ MVCC + Next-Key Lock ë°©ì‹ìœ¼ë¡œ íŒ¬í…€ ë¦¬ë“œë¥¼ ë°©ì§€í•˜ê¸°ë„ í•œë‹¤.
	- í•˜ì§€ë§Œ ì´ ë°©ë²•ì€ ë½ìœ¼ë¡œ ì ê¶ˆì„œ ë¬¼ë¦¬ì ìœ¼ë¡œ íŒ¬í…€ ë¦¬ë“œë¥¼ ë°©ì§€í•˜ëŠ” ê²ƒ 
	- ì¥ì  : ì¦‰ì‹œì„±, ë‹¨ìˆœì„± ë†’ìŒ 
	- ë‹¨ì  : ë½ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, ê²½í•©ì´ ë°œìƒí•˜ë©´ ì„±ëŠ¥ì´ ê¸‰ê²©íˆ ì €í•˜ë  ìˆ˜ ìˆë‹¤.


>[!tip] ë‚®ì€ ê²©ë¦¬ ìˆ˜ì¤€ìœ¼ë¡œ Phantom Readë¥¼ ë°©ì§€í•œë‹¤ëŠ”ê²Œ ì§„ì§œ ëŒ€ë‹¨í•œê±°ë‹¤.


## Repeatable Read ê²©ë¦¬ ìˆ˜ì¤€ - DBë³„ ì°¨ì´ 

> ë½ ê¸°ë°˜ vs MVCC ê¸°ë°˜ ì—ì„œ ì°¨ì´ê°€ ìˆë‹¤. 
#### 1. ë½ ê¸°ë°˜ DB ğŸ”’
ex. SQL Server, Oracle ê¸°ë³¸ ì„¤ì •


**âœ…ê°œë…** 
- **ì½ê¸° ì‹œ - ê³µìœ ë½(Shared Lock)ì„ ê±´ë‹¤.**
	- ì½ê¸° ì‘ì—…(`SELECT`) ì‹œ, í•´ë‹¹ í–‰ì— ê³µìœ  ë½ì„ ê±¸ê±°ë‚˜, ë„¥ìŠ¤íŠ¸-í‚¤ ë½ì„ í†µí•´ ê²€ìƒ‰ëœ ë ˆì½”ë“œ ë²”ìœ„ì— ë½ì„ ê±´ë‹¤.
	- ì´ë¡œ ì¸í•´, ë‹¤ë¥¸ **íŠ¸ëœì­ì…˜ì´ í•´ë‹¹ ë²”ìœ„ ë‚´ì—ì„œ ìƒˆë¡œìš´ í–‰ì„ ì‚½ì…í•˜ê±°ë‚˜ ê¸°ì¡´ í–‰ì„ ìˆ˜ì •/ì‚­ì œí•˜ëŠ” ê²ƒì„ ë°©ì§€** 
	- ì´ ë½ë“¤ì€ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ê±°ë‚˜ ë¡¤ë°±ë  ë•Œê¹Œì§€ ìœ ì§€
- **ì“°ê¸° ì‹œ - ë°°íƒ€ë½(Exclusive Lock)ì„ ê±´ë‹¤.**
	- ì“°ê¸° ì¤‘ì¸ rowë¥¼ ì½ìœ¼ë ¤ í•˜ë©´ ëŒ€ê¸°í•˜ê±°ë‚˜ ì°¨ë‹¨ë¨  

ğŸ’™ì¥ì  
- ì§ê´€ì ì´ê³  ê°•ë ¥í•œ Serializability ë³´ì¥ : íŠ¸ëœì­ì…˜ ê°„ ì¶©ëŒì´ ì¦‰ì‹œ íƒì§€ë˜ì–´ ëª…ì‹œì  í†µì œ ê°€ëŠ¥
- íŒ¬í…€ ë¦¬ë“œ ë°©ì§€ êµ¬í˜„ ê°„ë‹¨ 
- íŠ¸ëœì­ì…˜ ì¶©ëŒ ì‹œì ì´ ëª…í™• 

**ğŸ’¢ë‹¨ì ** 
- ë°ë“œë½ ë°œìƒ ê°€ëŠ¥ì„± ë†’ìŒ 
- ë‚®ì€ ë™ì‹œì„± : Lockì„ ì˜¤ë˜, ê¸¸ê²Œ ê±¸ê¸° ë•Œë¬¸ 
- ë‹¨ìˆœ Lockìœ¼ë¡œëŠ”, Phantom ReadëŠ” í•´ê²° ëª» í•¨ (Next-Key Lockì€ ê°€ëŠ¥í•˜ë‹¤ë„¤)

#### 2. MVCC ê¸°ë°˜ DB 
ex. MySQL InnoDB, PostgreSQL

âœ…ê°œë… 
- ë°ì´í„°ë¥¼ ì§ì ‘ ë½ì„ ê±°ëŠ” ëŒ€ì‹ , ê° íŠ¸ëœì­ì…˜ì´ ë°ì´í„°ì˜ íŠ¹ì • **"ìŠ¤ëƒ…ìƒ·"ì„** ë³´ê³  ì‘ì—…í•˜ë„ë¡ í•œë‹¤.
- ì“°ëŠ” íŠ¸ëœì­ì…˜ê³¼ ì½ëŠ” íŠ¸ëœì­ì…˜ì´ **ì¶©ëŒí•˜ì§€ ì•ŠìŒ**
- ë‹¨, ì“°ê¸° ì¶©ëŒ ì‹œì—ëŠ” **ì»¤ë°‹ ì‹œì ì— ì¶©ëŒ ê²€ì‚¬ ë° ë¡¤ë°± ë°œìƒ ê°€ëŠ¥**

ğŸ’™ì¥ì  
- ë†’ì€ ë™ì‹œì„± : ì½ê¸° ì“°ê¸° ê°„ì— ë¸”ë¡œí‚¹ì´ ë°œìƒí•˜ì§€ ì•Šì•„ ë†’ì€ ë™ì‹œì„± ì œê³µ 
- Phantom Readë„ ë°©ì§€ëœë‹¤.

ğŸ’¢ë‹¨ì  
- ì¶”ê°€ ê³µê°„ å¿… : ì´ì „ ë²„ì „ì˜ ë°ì´í„°ë¥¼ ìœ ì§€í•´ì•¼ í•˜ë¯€ë¡œ **ì¶”ê°€ì ì¸ ì €ì¥ ê³µê°„**ì´ í•„ìš”
- GC å¿… : ë” ì´ìƒ í•„ìš” ì—†ëŠ” ì´ì „ ë²„ì „ ë°ì´í„°ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì œê±°í•˜ê¸° ìœ„í•´ ê°€ë¹„ì§€ ì»¬ë ‰í„° í•„ìš” 


## Serializable vs Repeatable-Read


### ì˜ˆì‹œ sample

| id  | value |
| --- | ----- |
| 1   | A     |
| 2   | A     |
| 3   | B     |
| 4   | B     |
ìœ„ì˜ ê°™ì€ í…Œì´ë¸”ì´ ìˆë‹¤ê³  ê°€ì •í•  ë•Œ, 
Transaction 1 : valueê°€ Aì´ë©´ Bë¡œ ë³€ê²½
Transaction 2 : valueê°€ Bì´ë©´ Aë¡œ ë³€ê²½
í• ê±°ë¼ê³  ê°€ì •í•˜ì.

```SQL
SELECT * FROM test
INSERT INTO test(id, value) VALUES (1, 'A')
INSERT INTO test(id, value) VALUES (2, 'A');
INSERT INTO test(id, value) VALUES (3, 'B');
INSERT INTO test(id, value) VALUES (4, 'B');
```

#### ì˜ˆì‹œ in Repeatable Read(or Read Commited)

```SQL
[íŠ¸ëœì­ì…˜ 1]
BEGIN transaction isolation level Repeatable Read;

SELECT * FROM test;

UPDATE test SET value = 'B' WHERE value = 'A';

SELECT * FROM test;

[íŠ¸ëœì­ì…˜ 2]
BEGIN transaction isolation level Repeatable Read;

SELECT * FROM test;

UPDATE test SET value = 'A' WHERE
```


```SQL 
âœ…íŠ¸ëœì­ì…˜ 1 - UPDATE í›„ COMMIT ì „ READ
 id | value 
----+-------
  3 | B
  4 | B
  1 | B
  2 | B


âœ…íŠ¸ëœì­ì…˜ 2 - UPDATE í›„ COMMIT ì „ READ 
 id | value 
----+-------
  1 | A
  2 | A
  3 | A
  4 | A

âœ… ë‘˜ë‹¤ ì»¤ë°‹ í›„ ê²°ê³¼ 
 id | value 
----+-------
  1 | B
  2 | B
  3 | A
  4 | A
```
- T1ì€ A â†’ Bë¡œ ë³€ê²½
	- `id=1,2`ëŠ” T1ì˜ ì˜í–¥ â†’ `B`
- T2ëŠ” B â†’ Aë¡œ ë³€ê²½
	- `id=3,4`ëŠ” T2ì˜ ì˜í–¥ â†’ `A`

>[!tip] PostgresSQLì€ Snapshot ê¸°ë°˜ 
>- ê° íŠ¸ëœì­ì…˜ì€ ì‹œì‘ ì‹œì ì˜ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³ ì •ëœ Snapshotì„ ì‚¬ìš©
>- ë”°ë¼ì„œ íŠ¸ëœì­ì…˜1ì´ `COMMIT`ì„ í•´ë„ íŠ¸ëœì­ì…˜ 2ëŠ” ë³€ê²½ì‚¬í•­ì„ ë³´ì§€ ëª»í•œë‹¤.
>- ìœ„ì˜ ì˜ˆì‹œëŠ”, ì„œë¡œì˜ ë³€ê²½ ì‚¬í•­ì„ ë³´ì§€ ëª»í•œ ì±„ UPDATEë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” ê²ƒ 
>- íš¨ê³¼ : Phantom Read ë°©ì§€ + Repeatable Read 

>[!danger] í•œê³„ - ë…¼ë¦¬ì  ì¼ê´€ì„± ë¬¸ì œ 
>- ë™ì¼ ì¡°ê±´ì— ëŒ€í•œ ì—…ë°ì´íŠ¸ë¼ë„ íŠ¸ëœì­ì…˜ ê°„ ê²©ë¦¬ë¡œ ì¸í•´ ì¶©ëŒ ì—†ì´ ì‹¤í–‰ â¡ ìˆœì°¨ì  ì‹¤í–‰ì„ ì›í•  ì‹œ ì›í•˜ëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•ŠìŒ 
>- ì´ëŸ° ë…¼ë¦¬ì  ì¼ê´€ì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ ê²½ìš° ê²©ë¦¬ ìˆ˜ì¤€ì„ `SERIALIZABLE`ë¡œ ì˜¬ë ¤ì•¼ í•œë‹¤.


#### SERIALIZABLE - ë…¼ë¦¬ì  ì¼ê´€ì„± í•´ê²° âœ…
**ì‘ë™ ë°©ì‹**
	- `SERIALIZABLE` íŠ¸ëœì­ì…˜ì€ ë‹¤ë¥¸ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ íŠ¸ëœì­ì…˜ì˜ **ë³€ê²½ ì‚¬í•­**(ì½ê¸°/ì“°ê¸° ì¢…ì†ì„±)**ìœ¼ë¡œë¶€í„° ì™„ì „íˆ ê²©ë¦¬**ëœë‹¤. 
	- ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì´ëŸ¬í•œ **ì¢…ì†ì„±ì„ ê°ì§€**í•˜ê³ , **ì¶©ëŒì´ ë°œìƒí•˜ë©´ í•œìª½ íŠ¸ëœì­ì…˜ì„ ê°•ì œë¡œ ì‹¤íŒ¨(ë¡¤ë°±)ì‹œí‚¨ë‹¤.**

ê²©ë¦¬ìˆ˜ì¤€ì„ isolationìœ¼ë¡œ ë°”ê¾¸ê³  ì•ì˜ ì˜ˆì‹œë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•œë‹¤ê³  ê°€ì •í•˜ì
Transaction 1 `COMMIT` â¡ Transaction 2 `COMMIT`  âŒ ì˜¤ë¥˜ ë°œìƒ âŒ
```diff
-ERROR: could not serialize access due to read/write dependencies among
+ transactionsDETAIL: Reason code: Canceled on identification as a pivot during commit attempt. Hint: The transaction might succeed if retried.
```



PostgreSQLì´ T1ê³¼ T2 ê°„ì˜ **ì½ê¸°/ì“°ê¸° ì¢…ì†ì„±**ì„ ê°ì§€í–ˆê¸° ë•Œë¬¸
T1ì´ `A`ë¥¼ `B`ë¡œ ë°”ê¾¸ëŠ” ë™ì•ˆ, T2ëŠ” `B`ë¥¼ `A`ë¡œ ë°”ê¾¸ë ¤ê³  í•œ ê²ƒì„ ê°ì§€ 
> . `SERIALIZABLE` ê²©ë¦¬ ìˆ˜ì¤€ì€ ì´ëŸ¬í•œ ë™ì‹œì„± ì‘ì—…ì´ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ëœ ê²ƒì²˜ëŸ¼ ë³´ì´ê²Œ í•´ì•¼ í•˜ë¯€ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ëŠ” T2ì˜ ì»¤ë°‹ì„ í—ˆìš©í•˜ì§€ ì•Šê³  ë¡¤ë°±ì‹œí‚¨ë‹¤.



>[!tip] ì´ëŸ¬í•œ ë¬¸ì œ í•´ê²°ì€ SEREALIZABLE ë§ê³  ë¹„ê´€ì  ë½ìœ¼ë¡œë„ ê°€ëŠ¥í•˜ê¸´í•˜ë‹¤



### í‹€ë ¸ë˜ ë¬¸ì œ

#### ë¬¸ì œ 
Jeff executed the following update statement in the terminal on a table with 100 million rows;
```SQL
UPDATE TABLE STUDENTS SET GRADE = 100;
```

He realized that he forgot to add a where clause to only update the row where student id 50. Jeff executed a rollback immediately in the terminal.
```SQL
ROLLBACK;
```
He then rerun the statement again
```SQL
UPDATE TABLE STUDENTS SET GRADE = 100 WHERE STUDENT_ID = 50;
```
â“What is the state of the table after the last statement?

#### í•´ì„¤ 
ì²˜ìŒì—ëŠ” ë¡¤ë°±í–ˆìœ¼ë‹ˆ ì´ì „ì— ì„ ì–¸í•œ UPDATEëŠ” ì·¨ì†Œë˜ëŠ”ì§€ ì•Œì•˜ë‹¤.
í•˜ì§€ë§Œ ì•„ë‹ˆì˜€ë‹¤ â¡ **ìë™ ì»¤ë°‹ ì—¬ë¶€**ë¥¼ ìƒê°í•´ì•¼í•¨ 
(ê·¸ë¦¬ê³  BEGIN transactionë„ ì—†ëŠ”ë° ì™œ ê·¸ëŸ° ìƒê°ì„ í–ˆëŠ”ì§€.....)

ëŒ€ë¶€ë¶„ì˜ CLI(MySQL, Postgres psql ë“±)ì—ì„œëŠ” ê° SQLë¬¸ì´ ëë‚˜ë©´ **ìë™ìœ¼ë¡œ ì»¤ë°‹**ì´ ì¼ì–´ë‚œë‹¤.
**ì²« UPDATEë¥¼ ì‹œì‘í•˜ê³  ê·¸ë‹¤ìŒ ROLLBACKì„ í•´ë„ ì²« UPDATEëŠ” ì»¤ë°‹ëœ ìƒíƒœë¡œ ROLLBACKì´ íš¨ê³¼ê°€ ì „í˜€ ì—†ë‹¤.**






