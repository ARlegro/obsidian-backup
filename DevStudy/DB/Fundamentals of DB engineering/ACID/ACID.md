## Atomicity

> RDBMS를 정의하는 4가지 ACID 속성 중 하나  
> NOSQL, graph 등의 데이터베이스에도 적용되는 매우 중요한 개념 

### Concept 
>[!Tip] 트랜잭션 내 모든 쿼리는 반드시 성공해야한다.

- **단어 유래** 
	- 화학에서 **더 이상 나눠지지 않는** 기초적인 요소를 '**원자**'라고 한다
	- **Transcation은 작업의 단위**인데, 원자성을 가진다는 것은 **작업의 단위가 더 이상 쪼개질 수 없다**는 개념이다.
	  
- **핵심** 
	> 만약 단 하나의 쿼리라도 실패한다면, 어떤 이유에서든 해당 트랜잭션은 즉시 ROLLBACK되어야 한다. 
	- 즉, 100개의 쿼리 중 **1개의 쿼리만 잘못돼도 전체 트랜잭션은 무효화**!!!
	- 이것이 Atomicity의 원칙 

>[!danger] **Transaction 실패 조건**  
>- 제약 조건 실패
>- 중복 PK 오류
>- SQL 문법 오류  등 
>  > 이 중 하나라도 실패하면 전체 트랜잭션 롤백 

### 트랜잭션 중 데이터 베이스 다운 시 
>[!QUESTION] 만약 트랜잭션 도중 데이터베이스가 다운된다면 ❓
>이때는 사용자가 명시적으로 `ROLLBACK` 명령을 내릴 수 없다. 💢

#### 1. 커밋 전 DB crash 
- 쿼리 자체는 실패하지 않았지만 **커밋이 되지 않았기 때문에** 트랜잭션은 실패로 간주.
	  
#### 2. 데이터베이스 재시작 후 처리 
- 서버가 다운됐기 때문에 메모리 버퍼, 네트워크 세션 모두 사라진 상태이다.
- 재시작 되면, 시스템은 이전에 진행 중이던 **트랜잭션이 커밋되지 않은 채로 충돌했음을 감지**
- 그리고 이 트랜잭션이 만든 모든 변경 사항을 `ROLLBACK` 
- 즉, 쿼리 자체가 실패하지는 않았어도 DB가 재시작이라면 그 트랜잭션은 전부 `ROLLBACK`
>[!tip] 중단된 트랜잭션 감지 및 롤백 수행 
	  
#### 3. 데이터베이스 구현 방식별 차이
(1) **낙관적 COMMIT 방식** DB일 경우  
- 일부 데이터베이스는 낙관적인 COMMIT을 사용한다.
- **❓낙관적 COMMIT 이란 ❓**
	- 트랜잭션 실행 중 **발생한 변경 사항을 즉시 disk(WAL 등)에 기록**하고 `COMMIT` 시에는 단순히 플래그만 업데이트하여 완료하는 방식 
	- WAL 기반 시스템에서 많이 사용한다 
- **장점** ✅
	- `COMMIT` 속도가 빠르다 
- **단점** ❌
	- **`ROLLBACK` 시 불리** : `ROLLBACK`시에는 **disk에 기록된 변경 사항을 되돌리는 추가 작업**이 필요해 느릴 수 있다. 
	- 시스템 장애 발생 시, WAL 로그를 기반으로 한 Undo/Redo 복구 과정이 必  

**(2) 지연 COMMIT 방식**
- **❓지연 COMMIT 이란 ❓**
	- 트랜잭션 중 변경 사항을 메모리(버퍼)에만 저장해 두었다가 **`COMMIT` 시점에 모든 변경 사항을 disk로 한 번에 Flush 하는 경우** 
- **특장점** ✅
	- `ROLLBACK`이 매우 빠르다 : 단순히 메모리의 내용만 버리면 되므로 
	- I/O 부담이 적다

- **단점** ❌
	- `COMMIT` 시점에 I/O작업이 몰리는 문제 (느림)
	- 장애 발생 시 커밋되지 않은 작업이 모두 유실되어 복구에 불리 
  > 어느 방식이든 트랜잭션의 Atomicity 보장을 위한 신중한 설계가 必


> 그니까 DB별로 설계가 달라서 DB에 문제 생겼을 때, 원자성을 보장하기 위한 과정이 다르다는 것 


>[!EXAMPLE] DB 재시작 후의 동작 
>- 일부(과거) DB : 롤백 완료 전까지 재시작을 허용하지 않음(전체 시스템 실행 차단)
>- **현대(최근) DB** : 해당 트랜잭션만 롤백 상태로 유지하고 **나머지 기능은 사용 가능**
>- Note. 롤백은 수 분이 걸릴 수도 있다.





[[2. Isolation of ACID]]