

### Preview 
- μ“°μ΄λ” κ²©λ¦¬ μμ¤€ : `READ COMMITTED`
- μ¥μ  β…
	- λ™μ‹μ„±μ΄ λ†’λ‹¤
	- λ°λ“λ½ κΈ°νκ°€ μ¤€λ‹¤.
- λ‹¨μ  π’Ά
	- μ¶©λ μ‹ νΈλμ­μ…μ΄ λ΅¤λ°±λμ–΄ μ¤λ²„ν—¤λ“κ°€ μΌμ–΄λ‚  μ μλ‹¤.


### λ™μ‘ μ›λ¦¬ 
- **λ°μ΄ν„°λ² μ΄μ¤ λ½μ„ μ§μ ‘ μ‚¬μ©ν•μ§€ μ•μ:** λ°μ΄ν„°λ² μ΄μ¤μ ν–‰ λ λ²¨ λ½(λΉ„κ΄€μ  λ½)μ„ μ§μ ‘ μ‚¬μ©ν•μ§€ μ•κ³ , μ• ν”λ¦¬μΌ€μ΄μ… λ λ²¨μ—μ„ `version` μ»¬λΌμ„ ν†µν•΄ μ¶©λμ„ κ°μ§€ν•λ‹¤.
- **μ„±λ¥ μ΄μ :** λ½μΌλ΅ μΈν• λ€κΈ°(λΈ”λ΅)κ°€ μ—†μ–΄ λ™μ‹μ„±μ΄ λ†’μ€ ν™κ²½μ—μ„ μ„±λ¥μƒ μ΄μ μ΄ μμ„ μ μλ‹¤. (μ¶©λμ΄ μ¦μΌλ©΄ μ¬μ‹λ„λ΅ μΈν•΄ λ¶λ¦¬ν•  μλ„ μμ)
- **μ¬μ‹λ„ λ΅μ§ ν•„μ:** μ¶©λ λ°μƒ μ‹ μμ™Έκ°€ λ°μƒν•λ―€λ΅, μ• ν”λ¦¬μΌ€μ΄μ… μ½”λ“κ°€ μ΄λ¥Ό μ²λ¦¬ν•κ³  ν•„μ”ν•λ©΄ μ¬μ‹λ„ν•λ” λ΅μ§μ„ κµ¬ν„ν•΄μ•Ό ν•λ‹¤.
- **JPA `@Version` μ§€μ›:** Spring Data JPAλ‚ Hibernateλ” `@Version` μ–΄λ…Έν…μ΄μ…μ„ ν†µν•΄ λ‚™κ΄€μ  λ½μ„ λ§¤μ° μ‰½κ² μ μ©ν•  μ μλ„λ΅ μ§€μ›ν•λ‹¤.

#### Flow

| T1                                                               | T2                                              | DB                                       |
| ---------------------------------------------------------------- | ----------------------------------------------- | ---------------------------------------- |
| νΈλμ­μ… μ‹μ‘                                                          | νΈλμ­μ… μ‹μ‘                                         | ID : 1<br>Status : Free<br>Version : 1   |
| Read Row ID : 1<br>(Row Version = 1)<br>(μ‰μ–΄λ½ κ±Έλ¦Ό - But μ½μλ§μ λ½ λ°λ‚©) | Read Row ID : 1<br>(T1κ³Ό λ‘κ°™μ)                    | ID : 1<br>Status : Free<br>Version : 1   |
| SELEDT FOR UPDATE<br>(λ²„μ „ κ²€μ¦ μΌμ–΄λ‚¨ + λ°°νƒ€λ½)                           |                                                 | ID : 1<br>Status : Free<br>Version : 1   |
| UPDATE                                                           |                                                 |                                          |
| COMMIT                                                           | (νΈλμ­μ… μ¤‘)                                        | ID : 1<br>Status : Booked<br>Version : 2 |
|                                                                  | `SELECT FOR UPDATE`<br>**(λ²„μ „ κ²€μ¦ μΌμ–΄λ‚¨ + λ°°νƒ€λ½ μ‹λ„)** | ID : 1<br>Status : Booked<br>Version : 2 |
|                                                                  | **ROLLBACKλ¨ Cuz λ²„μ „μ΄ μ΄μƒν•΄μ„**                      | ID : 1<br>Status : Booked<br>Version : 2 |


### μ–Έμ  λ‚™κ΄€μ  λ½μ„ μ“ΈκΉ?
- μ½κΈ° μ‘μ—…μ΄ ν›¨μ”¬ λ” λ§μ€ μ• ν”λ¦¬μΌ€μ΄μ…μ— μ ν•© 
- λΉ„κ΄€μ λ§νΌ λ°μ΄ν„° λ¬΄κ²°μ„±μ„ λ³΄μ¥ν•  μ μ—†μ§€λ§ κµμ°©μƒνƒμ— λΉ μ§€μ§€ μ•μ•„ μ„±λ¥ μΆ‹λ‹¤.


---


## JPA, μ¤ν”„λ§μ—μ„μ λ‚™κ΄€μ  λ½ μ΄ν•΄ 
https://www.baeldung.com/jpa-optimistic-locking
### μ‹μ‘ - @Version
> @Version μ• λ…Έν…μ΄μ…μ„ μ•μ•„μ•Ό ν•λ‹¤.
> λ‚™κ΄€μ  λ½μ„ ν™μ„±ν™”ν•λ” λ° ν•„μμ  
> μ¤ν”„λ§μ€ `@Version` μ–΄λ…Έν…μ΄μ…μ΄ λ¶™μ€ μ«μ νƒ€μ… μ†μ„±μ„ μ‚¬μ©ν•μ—¬ λ‚™κ΄€μ  λ½μ„ μ§€μ›

**@Version β“**
- @Versionμ΄ λ¶™μΌλ©΄ `UPDATE` μΏΌλ¦¬μ—λ” **λ°μ΄ν„°λ² μ΄μ¤μ— μ €μ¥λ λ²„μ „μ΄ μ‹¤μ λ΅ λ³€κ²½λμ§€ μ•μ•λ”μ§€ ν™•μΈν•λ” `WHERE` μ μ΄ ν¬ν•¨**λλ‹¤.
- λ§μ•½ λ³€κ²½λμ—λ‹¤λ©΄, `OptimisticLockingFailureException`μ΄ λ°μƒ
- λ§μ•½ λ³€κ²½λμ§€ μ•μ•λ‹¤λ©΄, `UPDATE`κ°€ μ»¤λ°‹λκ³  version μ†μ„±μ κ°’μ΄ μ¦κ°€ν•λ‹¤
- κ·μΉ™
	- κ° μ—”ν‹°ν‹°λ” ν•λ‚μ λ²„μ „ μ†μ„±λ§ κ°€μ§ μ μλ‹¤.
	- λ²„μ „μ μ†μ„± νƒ€μ…μ€ : int, Integer, long, Long, short, Short, Timestamp κ°€λ¥ 
	- μ—¬λ¬ ν…μ΄λΈ”μ— λ§¤ν•‘λ μ—”ν‹°ν‹°μ κ²½μ° **'μ£Ό ν…μ΄λΈ”'μ— λ°°μΉ**λμ–΄μ•Ό ν•λ‹¤.
	- Versionμ†μ„±μ„ μ§μ ‘ μ—…λ°μ΄νΈν•κ±°λ‚ μ¦κ°€μ‹μΌμ„λ” μ•λλ‹¤.
		- μ¤λ΅μ§€ μμ†μ„± κ³µκΈ‰μλ§μ΄ ν•΄μ•Ό ν•¨
		- κ·Έλμ•Ό λ°μ΄ν„°μ μΌκ΄€μ„± μ μ§€λ¨ 

> [!WARNING] λ‚™κ΄€μ  λ½μ„ μ„ν•΄ λ°λ“μ‹ @Versionμ„ μ¨μ•Όν•λ” κ²ƒμ€ μ•„λ‹λ‹¤.
> λ‹¨μ§€ μ¤ν”„λ§μ—μ„ μ„ νΈν•λ” λ°©λ²•μΌ λΏμ΄λ‹¤.


> **optimistic locking is based on detecting changes on entities by checking their version attribut**



λ‚μ¤‘μ— μ¶”κ°€ν•κΈ° 

https://www.baeldung.com/jpa-optimistic-locking


---
### μλ°” μμ‹

μΌλ‹¨ ν…μ΄λΈ”μ€ μ•„λμ™€ κ°™μ•λ”λ°, Version ν•„λ“λ¥Ό μ¶”κ°€ν•  κ²ƒ 

```java
@Version
private int version;
```