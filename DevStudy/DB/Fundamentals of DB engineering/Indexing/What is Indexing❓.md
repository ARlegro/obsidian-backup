

### ì¸ë±ìŠ¤ëž€ â“
> ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì— ëŒ€í•œ ê²€ìƒ‰ ì„±ëŠ¥ì„ ë†’ì—¬ì£¼ëŠ” ìžë£Œ êµ¬ì¡° 
> #ë°ì´í„°êµ¬ì¡° #íš¨ìœ¨ì _ê²€ìƒ‰
- ê¸°ì¡´ í…Œì´ë¸” ìœ„ì— êµ¬ì¶•í•˜ê³  í• ë‹¹í•˜ëŠ” ë°ì´í„° êµ¬ì¡°
- í…Œì´ë¸”ì„ ì‚´íŽ´ë³´ê³  ë¶„ì„í•˜ì—¬ ì¼ì¢…ì˜ **ì§€ë¦„ê¸¸**ì„ ë§Œë“œëŠ” ì—­í• 
- ì‹¤ìƒí™œ ì˜ˆì‹œ : ì‚¬ì „ì— label ë¶™ì–´ ìžˆëŠ” ê²ƒ 
- í”í•œ ì¸ë±ìŠ¤ ìœ í˜•ìœ¼ë¡œëŠ” B-Tree, LMS treesê°€ ìžˆë‹¤. (ì´ê±°ëŠ” ë‚˜ì¤‘ì—)

ëª¨ë“  ê¸°ë³¸ í‚¤(Primary Key)ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ê°€ì§„ë‹¤. ì´ëŠ” B-tree ì¸ë±ìŠ¤???



### ì„±ëŠ¥ ë¹„êµí•˜ê¸° ì „ ì„¸íŒ… : ì¸ë±ì‹± O or X 

#### ê¸°ë³¸ ì„¸íŒ… ë° ë¶„ì„ 
í…Œì´ë¸” ìƒì„± í›„ í…Œì´ë¸” ì •ë³´ë¥¼ ë³¼ ê²ƒì´ë‹¤.
```SQL
CREATE TABLE employees
(
    id serial PRIMARY KEY,
    name VARCHAR(10)
)

#psql /d employees

                                  Table "public.employees"
 Column |         Type          | Collation | Nullable |                Default                
--------+-----------------------+-----------+----------+---------------------------------------
 id     | integer               |           | not null | nextval('employees_id_seq'::regclass)
 name   | character varying(10) |           |          | 
Indexes:
    "employees_pkey" PRIMARY KEY, btree (id)

```
- ì¸ë±ìŠ¤ë¥¼ ì„¤ì •í•˜ì§€ ì•Šì•˜ëŠ”ë°, ê¸°ë³¸ì ìœ¼ë¡œ ì¸ë±ìŠ¤ê°€ ì„¤ì •ë˜ì–´ ìžˆë‹¤.
	- ì´ìœ  : **ëª¨ë“  Primary KeyëŠ”** ê¸°ë³¸ì ìœ¼ë¡œ **b-tree ì¸ë±ìŠ¤**ë¥¼ ê°€ì§€ê³  ìžˆë‹¤ â­

#### ë”ë¯¸ ë°ì´í„° - 100ë§Œ 
```SQL 
INSERT INTO employees(name)
SELECT 
    'ì§ì›' || LPAD(n::text, 7, '0')
FROM generate_series(1, 1000000) AS s(n)
```

```SQL
SELECT * FROM employees LIMIT 10;
id,name
1,ì§ì›0000001
2,ì§ì›0000002
3,ì§ì›0000003
4,ì§ì›0000004
5,ì§ì›0000005
6,ì§ì›0000006
7,ì§ì›0000007
8,ì§ì›0000008
9,ì§ì›0000009
10,ì§ì›0000010
```


#### EXPLAIN ANALYZE ë„ìž… 
ì¿¼ë¦¬ ì„±ëŠ¥ì„ ë¹„êµí•˜ê¸° ìœ„í•´ **`EXPLAIN ANALYZE`** ë¥¼ ì‚¬ìš©í•  ê²ƒ
- _ì¿¼ë¦¬ë¥¼ ì‹¤ì œë¡œ ì‹¤í–‰í•œ ë’¤ì— ê·¸ ê²°ê³¼ë¥¼ í†µí•´ ì‹¤í–‰ ê³„íšì„ ë³´ì—¬ì¤€ë‹¤_.
- ì‹¤í–‰í•  ì¿¼ë¦¬ ì„¤ëª…í•´ì£¼ê³ , ì‹œê°„ì´ ì–¼ë§ˆë‚˜ ê±¸ë ¸ëŠ”ì§€ ì•Œë ¤ì¤€ë‹¤.


ì•„ëž˜ëŠ” í…ŒìŠ¤íŠ¸ ê²°ê³¼ì´ë‹¤. 
```SQL
-- ëª¨ë“  column
EXPLAIN ANALYZE SELECT * FROM employees WHERE id = 1;

-- idë§Œ ê°€ì ¸ì˜¤ê¸° 
EXPLAIN ANALYZE SELECT id FROM employees WHERE id = 1;

-- ----
QUERY PLAN

Index Scan using employees_pkey on employees  (cost=0.15..8.17 rows=1 width=42) (actual time=0.027..0.027 rows=0 loops=1)
  Index Cond: (id = 1)
Planning Time: 0.633 ms
Execution Time: 0.058 ms

------
Index Only Scan using employees_pkey on employees  (cost=0.15..8.17 rows=1 width=4) (actual time=0.013..0.014 rows=0 loops=1)
  Index Cond: (id = 1)
  Heap Fetches: 0
Planning Time: 0.488 ms
Execution Time: 0.092 ms

```
- 100ë§Œê°œì˜ ë°ì´í„°ë¥¼ ì „ë¶€ ë’¤ì§€ëŠ”ê²Œ ì•„ë‹ˆë‹¤.
- ìžë™ìœ¼ë¡œ ì¸ë±ì‹±ì´ ì¼ì–´ë‚¬ë‹¤. 
	- B-Tree ì¸ë±ìŠ¤ë¥¼ ê°€ì§„ PRIMARY KEYë¥¼ í™œìš© âž¡ ë¹¨ë¼ì§ 

â˜‘`Heap Fetches` 
ë‘ë²ˆì§¸ id ì»¬ëŸ¼ë§Œ ê°€ì ¸ì˜¤ëŠ” ëª…ë ¹ë¬¸ì˜ `EXPLAIN ANALYZE`ë¥¼ ë³´ë©´ `Heap Fetches = 0`ì´ ìžˆë‹¤.
- **ì´ìœ ** : ì¿¼ë¦¬í•œ ê°’, ì¦‰ **IDëŠ” ì¸ë±ìŠ¤ì— ìžˆì—ˆê¸° ë•Œë¬¸ì—** ì´ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ **íž™(heap)ìœ¼ë¡œ ê°ˆ í•„ìš”ê°€ ì—†ì—ˆë‹¤**. IDê°€ ì¸ë±ìŠ¤ì— ìžˆì—ˆê¸° ë•Œë¬¸ìž…ë‹ˆë‹¤. ê·¸ëž˜ì„œ ê·¸ëƒ¥ ì¸ë¼ì¸ìœ¼ë¡œ ê°€ì ¸ì˜¨ ê²ƒ 
- ì´ë¥¼ **"ì¸ë¼ì¸(inline) ì¿¼ë¦¬"** ë¼ê³  í•¨ 

> ë§Œì•½ ì¸ë¼ì¸ ì¿¼ë¦¬ê°€ ê°€ëŠ¥í•˜ë‹¤ë©´ ì ‘ê·¼ ë¹„ìš©ì´ ë¹„ì‹¼ Heapì„ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë¼ì„œ êµ‰ìž¥ížˆ ë¹¨ë¼ì§ˆ ê²ƒ 

**â˜‘Planning time** 
- ì¿¼ë¦¬ë¥¼ ê³„íš
- **ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í• ì§€**â“ì•„ë‹ˆë©´ **í…Œì´ë¸”ì„ ìŠ¤ìº”í• ì§€**â“ ê²°ì •í•˜ëŠ” ê²ƒ

**â˜‘Execution Time**
- ì‹¤ì œ ìž‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒ


>[!QUESTION] ì¸ë±ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ”ê±° ìžì²´ë„ ì‹œê°„ì´ ê±¸ë¦¬ì§€ ì•Šì„ê¹Œ â“
>- ì¼ë°˜ì ìœ¼ë¡œ ì‹¤ì œ í…Œì´ë¸”ì´ ì¸ë±ìŠ¤ë³´ë‹¤ í›¨ì”¬ í¬ë‹¤.
>- ì¸ë±ìŠ¤ëŠ” í•˜ë‚˜ì˜ ë°ì´í„° êµ¬ì¡°ì´ê³ , í…Œì´ë¸”ì€ ë‹¤ë¥¸ ë°ì´í„° êµ¬ì¡°
>- í…Œì´ë¸”ì´ ì‹¤ì œë¡œ ë” ë” ë¬´ê²ë‹¤ â—â—
>- ë”°ë¼ì„œ, í…Œì´ë¸”ì— ê°€ëŠ” ê²ƒì„ ìµœëŒ€í•œ í”¼í•˜ë ¤ê³ í•œë‹¤.


## ë³¸ê²© ì‹¤í—˜ 

> [!success] ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë‚˜ëˆŒ ê²ƒ (ì´ë¥¼ í†µí•´ ë¹„ìš© ë¹„êµí•  ê²ƒ)
> 1. IDë§Œ ìˆ˜ì • 
> 2. name ë§Œ ìˆ˜ì • 
> 3. name ì¡°ê±´ìœ¼ë¡œ ID ì¡°íšŒ 




### ì‹œë‚˜ë¦¬ì˜¤ 1. Index Only Scan
> IDë§Œ ì‚¬ìš©í•´ì„œ ì¡°íšŒ 

```SQL
EXPLAIN ANALYZE SELECT id FROM employees WHERE id = 5000;
```

```SQL
 Index Only Scan using employees_pkey on employees  (cost=0.42..4.44 rows=1 width=4) (actual time=0.912..0.913 rows=1 loops=1)
   Index Cond: (id = 5000)
   Heap Fetches: 0
 Planning Time: 4.492 ms
 Execution Time: 0.988 ms
(5 rows)
```
Index Only Scan 
- ì¼ë‹¨ Heapì˜ì—­ì— ì ‘ê·¼í•˜ì§€ ì•Šì•˜ë‹¤ëŠ” ê²ƒì„ ë³´ë©´ ë¹ ë¥¼ ê²ƒì´ë¼ê³  ì˜ˆìƒí•  ìˆ˜ ìžˆë‹¤.
- Execution Timeì€ 0.027ms ë¡œ ë§¤ìš° ë¹ ë¥´ë‹¤.

> ìžì„¸í•œ ê²°ê³¼ ë‚´ìš© ë¶„ì„ì€ `EXPLAIN ANALYZE ë„ìž…`ë¶€ë¶„ì—ì„œ í–ˆìœ¼ë‹ˆ Pass 




### ì‹œë‚˜ë¦¬ì˜¤ 2. name ì¡°íšŒí•˜ê¸° 

#### ì‹¤í–‰ 
```SQL 
EXPLAIN ANALYZE SELECT name FROM employees WHERE id = 6000;

Index Scan using employees_pkey on employees  (cost=0.42..8.44 rows=1 width=14) (actual time=0.816..0.819 rows=1 loops=1)
	 Index Cond: (id = 6000)
Planning Time: 1.237 ms
Execution Time: 0.998 ms
(4 rows)
```
ì—¥â“ë³„ ì°¨ì´ ì—†ëŠ”ë°???. ìœ„ì˜ ê²°ê³¼ëŠ” SQL Clientë¥¼ ì¼ì„ ê²½ìš°ì˜ ê²°ê³¼ì´ë‹¤.

í˜¹ì‹œë‚˜ ì‹œë‚˜ë¦¬ì˜¤ 1ë²ˆì—ì„œ ìºì‹œëœ ê²ƒì¼ìˆ˜ë„ ìžˆê¸°ì— ë‹¤ë¥¸ id ë¡œ ìž¬ì‹œë„ 
```SQL

Index Scan using employees_pkey on employees  (cost=0.42..8.44 rows=1 width=14) (actual time=6.077..6.083 rows=1 loops=1)
   Index Cond: (id = 12000)
Planning Time: 0.090 ms
Execution Time: 6.115 ms
(4 rows)
```
â—ë§¤ìš° ëŠë ¤ì¡Œë‹¤ 6.115ms (ì´ì „ì—ëŠ” 0.988)â—

#### ëŠë¦° ì´ìœ  ë¶„ì„
- ì¸ë±ìŠ¤ì—ì„œ IDë¥¼ ì°¾ì•˜ì§€ë§Œ, nameì»¬ëŸ¼ì„ ì–»ê¸°ìœ„í•´ì„œëŠ” **ë””ìŠ¤í¬ì— ìžˆëŠ” í…Œì´ë¸” í–‰ìœ¼ë¡œ ì í”„í•´ì•¼ í–ˆê¸° ë•Œë¬¸**
 - Indexì—ëŠ” `name` ì»¬ëŸ¼ì´ ì—†ê³ , **Heap-Tableì— ìžˆë‹¤**. â­â­â­
 - ê·¸ë ‡ê¸° ë–„ë¬¸ì— ì‹¤ì œë¡œ ê²€ìƒ‰í•˜ê¸° ìœ„í•´ì„œëŠ” ìˆœì°¨ì ìœ¼ë¡œ employees í…Œì´ë¸”ì„ Scaní•´ì•¼ í•¨ (ìµœì•…ì˜ ê²½ìš° full-table-scan)
- ì´ê²ƒì€ ê°€ëŠ¥í•œ í•œ í”¼í•´ì•¼ í•œë‹¤. ðŸ’¢ 

>[!tip] PostgreSQLì˜ ìˆœì°¨ ìŠ¤ìº” ìµœì í™” 
>- PostgresëŠ” ì—¬ëŸ¬ ìŠ¤ë ˆë“œ, ì¦‰ ì›Œì»¤ ìŠ¤ë ˆë“œë¥¼ ì‹¤í–‰í•˜ì—¬ **ë³‘ë ¬ë¡œ ìˆœì°¨ ìŠ¤ìº”**ì„ ìˆ˜í–‰í•¨ìœ¼ë¡œì¨ ì¢€ ë” ì˜ë¦¬í•˜ê²Œ í–‰ë™í•˜ë ¤ê³  í•¨.
>- ê·¸ëž˜ì„œ ì‹¤ì œ PostgreSQLì€ **ì´ë¡ ë³´ë‹¤ëŠ” ì¢€ ë” ë¹ ë¥¸ ìˆœì°¨ ìŠ¤ìº”ì´ ê°€ëŠ¥** 
>- **ê·¸ëž˜ë„ í”¼í•˜ë ¤ê³  ë…¸ë ¥í•´ë´ì•¼ í•¨** 


>[!danger] ì–´ì°Œëë˜ Heap ì ‘ê·¼ì„ í”¼í•˜ë ¤ê³  ë…¸ë ¥í•´ë¼. ê·¸ ë‹¤ìŒì€ Full-Table-Scaní”¼í•˜ë ¤ê³  ë…¸ë ¥


### ì‹œë‚˜ë¦¬ì˜¤ 3. nameì„ WHERE ì ˆì— ì‚¬ìš© ðŸ”
>[!danger] ìš°ì„ , ì´ CASEëŠ” êµ‰ìž¥ížˆ ì˜¤ëž˜ê±¸ë¦´ ê²ƒì´ë‹¤.

ì—†ëŠ” ì´ë¦„ì„ ì¡°ê±´ìœ¼ë¡œ ë„£ì–´ì„œ ì¿¼ë¦¬ë¥¼ ì§¤ ê²ƒ. ì´ë ‡ê²Œ í•´ì•¼ Full-Tabel-Scanì´ ë¬´ì¡°ê±´ ì¼ì–´ë‚˜ë¯€ë¡œ 

```SQL 
EXPLAIN ANALYZE SELECT id FROM employees WHERE name = 'szzzz';
```

```SQL 
Gather  (cost=1000.00..12578.43 rows=1 width=4) (actual time=101.348..103.515 rows=0 loops=1)
   Workers Planned: 2
   Workers Launched: 2
   ->  Parallel Seq Scan on employees  (cost=0.00..11578.33 rows=1 width=4) (actual time=94.829..94.830 rows=0 loops=3)
         Filter: ((name)::text = 'szzzz'::text)
         Rows Removed by Filter: 333333
Planning Time: 0.652 ms
Execution Time: 103.542 ms  <<<< 
(8 rows)
```
- ê±¸ë¦° ì‹œê°„ : 103 ms ðŸ’¢
- ë§¤ìš° ë§¤ìš° ëŠë¦¬ë‹¤.
- **ì´ìœ  ë¶„ì„**
	1. name ì»¬ëŸ¼ì€ Indexê°€ ì—†ë‹¤.
	2. ì¦‰, nameì¡°ê±´ì— ë§žëŠ” ë°ì´í„°ë¥¼ ì°¾ê¸° ìœ„í•´ì„œëŠ” í…Œì´ë¸”ì„ í•˜ë‚˜í•˜ë‚˜ ì „ë¶€ ì°¾ì•„ì•¼ í•¨ 

*Note : PostgreSQLì€  Parallel Seq Scanìœ¼ë¡œ ë‚´ë¶€ ìµœì í™”ê°€ ìžˆê¸´í•´ì„œ ì´ë¡ ë³´ë‹¤ ë” ë¹ ë¥¼ ê²ƒ*


### LIKE ì¿¼ë¦¬ê°€ ì•ˆ ì¢‹ì€ ì´ìœ  
`LIKE`ëŠ” ê°€ìž¥ ë‚˜ìœ ì¿¼ë¦¬ë¬¸ ì¤‘ì— í•˜ë‚˜ì´ë‹¤ 
- ëª¨ë“  í–‰ì„ í†µê³¼í•˜ë©´ì„œ ì¼ì¹˜ ì—¬ë¶€ë¥¼ í™•ì¸í•´ì•¼ í•˜ê¸° ë•Œë¬¸ 
- 'ì‹œë‚˜ë¦¬ì˜¤ 3'ê°™ì€ Full-Table-Scanì´ ë°œìƒ




--- 
## ì¸ë±ìŠ¤ ë„ìž… 

### ì¸ë±ìŠ¤ ë§Œë“¤ê¸° 

```SQL
CREATE INDEX ì¸ë±ìŠ¤ëª… ON í…Œì´ë¸”ëª…(ì»¬ëŸ¼ëª…)
-- ë³´í†µ ì¸ë±ìŠ¤ëª…ì€ 'í…Œì´ë¸”ëª…_ì»¬ëŸ¼ëª…'ìœ¼ë¡œ í•œë‹¤.
```

ì°¸ê³ ë¡œ ì¸ë±ìŠ¤ ìƒì„±í•˜ëŠ” ë° ì‹œê°„ ì¢€ ê±¸ë¦°ë‹¤ Cuz B-Treeë¥¼ ë§Œë“¤ì–´ì•¼í•˜ë¯€ë¡œ

ì´ì „ì— ëŠë ¸ë˜ (ì‹œë‚˜ë¦¬ì˜¤ 3) ê°™ì€ ì¿¼ë¦¬ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸° 

```SQL
EXPLAIN ANALYZE SELECT id, name FROM employees WHERE name = 'DF';
```

```SQL
 Index Scan using employees_name on employees  (cost=0.42..8.44 rows=1 width=18) (actual time=0.820..0.845 rows=0 loops=1)
   Index Cond: ((name)::text = 'DF'::text)
 Planning Time: 2.700 ms
 Execution Time: 0.872 ms
(4 rows)
```
- **ì‹¤í–‰ ì‹œê°„ì´ ì—„ì²­ ì¤„ì—ˆë‹¤.** (103.54ms -> 0.87) â­
- ëŒ€ì‹  Planning Timeì´ ì¡°ê¸ˆ ëŠ˜ìŒ
- ì´ìœ  ë¶„ì„ 
	1. Indexë¡œ ì¸í•´ ë” ì ì€ Rowë¥¼ ì½ì–´ë„ ëœë‹¤.
	2. ì‹¬ì§€ì–´, id-nameì€ ì „ë¶€ ì¸ë±ìŠ¤ë¡œ ë˜ì–´ìžˆê¸°ì— ê¸ˆë°© ì°¾ëŠ”ë‹¤.


>[!tip] ê°€ë” Bitmap Index Scanì´ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.
>- ì´ê±´ DBê°€ ì•Œì•„ì„œ ì •í•˜ëŠ” ê²ƒ 


### ë§Œì•½ ì¸ë±ìŠ¤ + Likeë¥¼ ì“´ë‹¤ë©´?
>[!danger] ì“°ì§€ë§ˆë¼
>ì´ê±°ëŠ” Indexë¡œë„ í•´ê²°í•˜ì§€ ëª» í•  ì •ë„ë¡œ ëŠë¦° ì¿¼ë¦¬ì´ë‹¤.
>LIKEì¿¼ë¦¬ëŠ” Indexë¡œ Scanì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
>ì¦‰, ìµœì í™”ê°€ íž˜ë“ ê²Œ LIKE ì¿¼ë¦¬ì´ë‹¤.
>ë¹„ì‹¸ê¸°ë§Œ í•¨ 
```SQL 
EXPLAIN ANALYZE SELECT id, name FROM employees WHERE name LIKE '%deFhzc%'
```
- %~%ëŠ” Single Valueê°€ ì•„ë‹ˆë‹¤.

>

